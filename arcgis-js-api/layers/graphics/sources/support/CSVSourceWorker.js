// COPYRIGHT © 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","@dojo/framework/shim/Set","dojo/number","dstore/Csv","../../../../geometry","../../../../request","../../../../core/Error","../../../../core/has","../../../../core/lang","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../geometry/projection","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/webMercatorUtils","../../OptimizedFeature","../../OptimizedGeometry","../../data/FeatureStore","../../data/projectionSupport","../../data/QueryEngine","./clientSideDefaults"],function(e,t,i,r,n,a,o,l,u,s,d,f,p,c,m,y,g,h,v,F,_,N){Object.defineProperty(t,"__esModule",{value:!0});var I=N.createDrawingInfo("esriGeometryPoint"),b=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong"];t.csvLatitudeFieldNames=["lat","latitude","y","ycenter","latitude83","latdecdeg","point-y"],t.csvLongitudeFieldNames=["lon","lng","long","longitude","x","xcenter","longitude83","longdecdeg","point-x"],t.csvDetectedDelimiters=[","," ",";","|","\t"];var T=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i,w=[0,0],x=function(){function e(e,t){this.x=e,this.y=t}return e}(),D=function(){var e=n._parseInfo(),t=new RegExp("^"+e.regexp+"$"),i=new RegExp("["+e.group+"\\s\\xa0]","g"),r=e.factor;return function(n){var a=t.exec(n);if(e.factor=r,!a)return NaN;var o=a[1];if(!a[1]){if(!a[2])return NaN;o=a[2],e.factor*=-1}return+(o=o.replace(i,"").replace(e.decimal,"."))*e.factor}}(),E=function(){return"isInteger"in Number?Number.isInteger:function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}}(),j=function(){function e(){this._fieldsMap=new Map,this._queryEngine=null}return e.prototype.destroy=function(){this._queryEngine&&this._queryEngine&&this._queryEngine.destroy(),this._queryEngine=null},e.prototype.load=function(e){var t=this;return f.all([this._fetch(e.url),this._checkProjection(e&&e.parsing&&e.parsing.spatialReference)]).then(function(i){var r=i[0],n=t._parse(r,e.parsing);if(t._queryEngine=t._createQueryEngine(r,n),n.layerDefinition.extent=t._queryEngine.fullExtent,n.layerDefinition.timeInfo){var a=t._queryEngine.timeExtent,o=a.start,l=a.end;n.layerDefinition.timeInfo.timeExtent=[o,l]}return n})},e.prototype.applyEdits=function(e){return f.reject(new u("csv-source:editing-not-supported","applyEdits() is not supported on CSVLayer"))},e.prototype.queryFeatures=function(e){return void 0===e&&(e={}),this._queryEngine.executeQuery(e)},e.prototype.queryFeatureCount=function(e){return void 0===e&&(e={}),this._queryEngine.executeQueryForCount(e)},e.prototype.queryObjectIds=function(e){return void 0===e&&(e={}),this._queryEngine.executeQueryForIds(e)},e.prototype.queryExtent=function(e){return void 0===e&&(e={}),this._queryEngine.executeQueryForExtent(e)},e.prototype._fetch=function(e){if(!e)return f.reject(new u("csv-source:invalid-source","url not defined"));var t=p.urlToObject(e);return l(t.path,{query:t.query,responseType:"text"}).then(function(e){return e.data})},e.prototype._parse=function(e,t){void 0===t&&(t={});for(var i={columnDelimiter:t.columnDelimiter,layerDefinition:null,locationInfo:{latitudeFieldName:t.latitudeField,longitudeFieldName:t.longitudeField}};e&&"\n"===e[0];)e=e.slice(1);"\n"!==e[e.length-1]&&(e+="\n");var r=this._readFirstLine(e);if(!r)throw new u("csv","CSV is empty",{csv:e});if(!t.columnDelimiter){var n=this._inferDelimiter(r);if(!n)throw new u("csv-source:invalid-delimiter","Unable to detect the delimiter from CSV");i.columnDelimiter=n}var a=r.split(i.columnDelimiter),o=i.layerDefinition={name:"csv",drawingInfo:I,geometryType:"esriGeometryPoint",objectIdField:null,fields:[],timeInfo:t.timeInfo,extent:{xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,ymax:Number.NEGATIVE_INFINITY,spatialReference:t.spatialReference||{wkid:102100}}};if(!t.latitudeField||!t.longitudeField){var l=this._inferLocationInfo(a);if(!t.longitudeField&&!l.longitudeFieldName||!t.latitudeField&&!l.latitudeFieldName)throw new u("csv","Unable to identify latitudeField and/or longitudeField from CSV");i.locationInfo={longitudeFieldName:t.longitudeField||l.longitudeFieldName,latitudeFieldName:t.latitudeField||l.latitudeFieldName}}var s=this._inferFields(e,i.columnDelimiter,a,i.locationInfo);if(t.fields&&t.fields.length){for(var f=new Map,p=0,c=t.fields;p<c.length;p++){var m=c[p];f.set(m.name.toLowerCase(),m)}for(var y=0,g=s;y<g.length;y++){var m=g[y],h=f.get(m.name.toLowerCase());if(h){var v=m.name;d.mixin(m,h),m.name=v}this._fieldsMap.set(m.name.trim(),m),this._fieldsMap.set(m.name.trim().toLowerCase(),m)}}if(o.fields=s,!o.fields.some(function(e){return"esriFieldTypeOID"===e.type&&(o.objectIdField=e.name,!0)})){var m={name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,nullable:!1};o.objectIdField=m.name,o.fields.unshift(m),this._fieldsMap.set(m.name,m),this._fieldsMap.set(m.name.toLowerCase(),m)}if(o.timeInfo){var F=o.timeInfo;if(F.startTimeField){var _=this._fieldsMap.get(F.startTimeField.toLowerCase());_?(F.startTimeField=_.name,_.type="esriFieldTypeDate"):F.startTimeField=null}if(F.endTimeField){var N=this._fieldsMap.get(F.endTimeField.toLowerCase());N?(F.endTimeField=N.name,N.type="esriFieldTypeDate"):F.endTimeField=null}if(F.trackIdField){var b=this._fieldsMap.get(F.trackIdField.toLowerCase());F.trackIdField=b?b.name:null}F.startTimeField||F.endTimeField||(o.timeInfo=null)}return i},e.prototype._inferLocationInfo=function(e){var i=null,r=null;return e.forEach(function(e){var n,a=e.toLowerCase();n=t.csvLatitudeFieldNames.indexOf(a),-1===n||r||(r=e),-1===(n=t.csvLongitudeFieldNames.indexOf(a))||i||(i=e)}),{longitudeFieldName:i,latitudeFieldName:r}},e.prototype._inferFields=function(e,t,i,r){for(var n=[],a=this._sampleLines(e).map(function(e){return e.split(t).map(function(e){return e.trim()})}),o=this,l=0;l<i.length;l++)!function(e){var t=i[e];if(t===r.longitudeFieldName||t===r.latitudeFieldName)n.push({name:t,type:"esriFieldTypeDouble",alias:t});else{var l=a.map(function(t){return t[e]}),u=o._inferFieldType(l),s={name:t.replace(/[\s\'’‘\.\-\/\(\)]+/g,"_"),type:null,alias:t};switch(u){case"integer":s.type="esriFieldTypeInteger";break;case"double":s.type="esriFieldTypeDouble";break;case"date":s.type="esriFieldTypeDate",s.length=36;break;default:s.type="esriFieldTypeString",s.length=255}n.push(s)}}(l);return n},e.prototype._inferFieldType=function(e){var t=this;if(!e.length)return"string";var i=/[^+-.,0-9]/;return e.map(function(e){var r=!1;if(""===e||i.test(e))r=!0;else{var n=D(e);if(!isNaN(n))return/[.,]/.test(e)?"double":!E(n)||n>214783647||n<-214783648?"double":"integer";if(-1===e.indexOf("E"))r=!0;else{if(n=Number(e),!isNaN(n))return"double";if(-1===e.indexOf(","))r=!0;else{if(e=e.replace(",","."),n=Number(e),!isNaN(n))return"double";r=!0}}}if(r){if(!/^[-]?\d*[.,]?\d*$/.test(e)){var a=new Date(e);return t._isValidDate(a,e)?"date":"string"}return"string"}return"string"}).reduce(function(e,t){return e===t?t:"string"===e||"string"===t?"string":"double"===e||"double"===t?"double":void 0})},e.prototype._isValidDate=function(e,t){if(!e||"[object Date]"!==Object.prototype.toString.call(e)||isNaN(e.getTime()))return!1;var i=!0;if(s("chrome")&&/\d+\W*$/.test(t)){var r=t.match(/[a-zA-Z]{2,}/);if(r){for(var n=!1,a=0;!n&&a<=r.length;)n=!T.test(r[a]),a++;i=!n}}return i},e.prototype._readFirstLine=function(e){return e.substring(0,e.indexOf("\n")).trim()},e.prototype._sampleLines=function(e,t){void 0===t&&(t=10);for(var i=!1,r=[],n=e.indexOf("\n")+1;!i&&r.length<t;){var a=e.indexOf("\n",n);if(-1!==a){var o=void 0;o=-1===a&&n<e.length-1?e.substring(n).trim():e.substring(n,a).trim(),o&&r.push(o),n=a+1}else i=!0}return r},e.prototype._inferDelimiter=function(e){var i=0,r="";return t.csvDetectedDelimiters.forEach(function(t){var n=e.split(t).length;n>i&&(i=n,r=t)}),""===r?null:r},e.prototype._createQueryEngine=function(e,t){for(var i,n=t.locationInfo,l=n.latitudeFieldName,u=n.longitudeFieldName,s=t.layerDefinition,d=s.objectIdField,f=s.fields,p=s.extent,F=s.timeInfo,N=[],I=[],T=new r.Set,E=new r.Set,j=[],S=0,q=f;S<q.length;S++){var L=q[S],C=L.name,O=L.type;"esriFieldTypeDate"===O?T.add(C):b.indexOf(O)>-1&&E.add(C),C!==d&&j.push(C)}var M=new a;M.delimiter=t.columnDelimiter,M.fieldNames=j,M.newline="\n";var V=M.parse(e),k=0;V.shift();for(var R=0,P=V;R<P.length;R++){var G=P[R],Q=this._parseCoordinateValue(G[l]),U=this._parseCoordinateValue(G[u]);if(null!=U&&null!=Q&&!isNaN(Q)&&!isNaN(U)){G[l]=Q,G[u]=U;for(var Y in G)if(Y!==l&&Y!==u)if(T.has(Y)){var W=new Date(G[Y]);G[Y]=this._isValidDate(W,G[Y])?W.getTime():null}else if(E.has(Y)){var $=D(G[Y]);isNaN($)?G[Y]=null:G[Y]=$}G[d]=k,k++,N.push(new x(U,Q)),I.push(G)}}if(!m.equals({wkid:4326},p.spatialReference))if(m.isWebMercator(p.spatialReference))for(var z=0,A=N;z<A.length;z++){var Z=A[z];i=y.lngLatToXY(Z.x,Z.y,w),Z.x=i[0],Z.y=i[1]}else N=c.projectMany(N,o.SpatialReference.WGS84,p.spatialReference,null,!0);for(var B=new v.default({geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1}),J=new _.default({fields:t.layerDefinition.fields,geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1,timeInfo:F,objectIdField:d,spatialReference:p.spatialReference||{wkid:4326},cacheSpatialQueries:!0,featureStore:B}),H=[],X=0;X<N.length;X++){var K=N[X],ee=K.x,te=K.y,ie=I[X];ie[d]=X+1,H.push(new g.default(new h.default([],[ee,te]),ie,null,ie[d]))}return B.addMany(H),J},e.prototype._parseCoordinateValue=function(e){if(null==e||""===e)return null;var t=D(e);return(isNaN(t)||Math.abs(t)>181)&&(t=parseFloat(e)),t},e.prototype._checkProjection=function(e){return F.checkProjectionSupport(m.WGS84,e).catch(function(){throw new u("csv-layer","Projection not supported")})},e}();t.default=j});