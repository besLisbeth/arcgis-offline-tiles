// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","@dojo/framework/shim/array","@dojo/framework/shim/Map","../../../../../geometry","../../../../../request","../../../../../core/Error","../../../../../core/Logger","../../../../../core/promiseUtils","../../../../../core/throttle","../../../../../core/accessorSupport/decorators","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/data/FeatureStore","../../../../../layers/graphics/data/QueryEngine","../../../../../tasks/operations/query","../../../../../tasks/support/Query","./BaseController","./support/DispatchQueue"],function(e,t,r,i,n,o,s,u,a,c,h,p,d,l,f,y,g,v,_,m,b,S,F){function E(e){for(var t=0,r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return t}Object.defineProperty(t,"__esModule",{value:!0});var w=d.getLogger("esri.views.2d.layers.features.controllers.StreamController"),q=5e3,k=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="stream",t.errorString=null,t._started=!1,t._idCounter=0,t._tileDispatchMap=new a.default,t._updateIntervalId=0,t._reconnectWebSocketT=f.throttle(t._reconnectWebSocket,q,t),t._featureIds=[],t}return r(t,e),t.prototype.initialize=function(){var e=this;this.handles.add(this.watch("processor",this._switchProcessor.bind(this))),["connectionStatus","errorString"].forEach(function(t){e.watch(t,function(r){return e.remoteClient.invoke("setProperty",{propertyName:t,value:r})})}),this._updateIntervalId=setInterval(function(){return e._checkForUpdates()},64)},t.prototype.destroy=function(){clearInterval(this._updateIntervalId),this._destroyWebSocket(),this._tileDispatchMap.forEach(function(e){return e.destroy()}),this.queryEngine&&(this.queryEngine.destroy(),this._set("queryEngine",null)),this._tempQueryEngine&&this._tempQueryEngine.destroy()},Object.defineProperty(t.prototype,"updating",{get:function(){return!this._started||this._tempQueryEngine&&!!this._tempQueryEngine.featureStore.numFeatures||this._anyUpdatesQueued()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"connectionStatus",{get:function(){if(!this._websocket)return"disconnected";switch(this._websocket.readyState){case 0:case 1:return"connected";case 2:case 3:return"disconnected"}},enumerable:!0,configurable:!0}),t.prototype.onEdits=function(e){},t.prototype.queryFeatures=function(e){return this.queryEngine?this.queryEngine.executeQuery(e):l.resolve({features:[],fields:[]})},t.prototype.queryFeatureCount=function(e){return this.queryEngine?this.queryEngine.executeQueryForCount(e):l.resolve(0)},t.prototype.queryObjectIds=function(e){return this.queryEngine?this.queryEngine.executeQueryForIds(e):l.resolve([])},t.prototype.queryExtent=function(e){return this.queryEngine?this.queryEngine.executeQueryForExtent(e):l.reject({count:0,extent:null})},t.prototype.queryLatestObservations=function(e){return this.queryEngine?this.queryEngine.executeQueryForLatestObservations(e):l.resolve({features:[],fields:[]})},t.prototype.redraw=function(){},t.prototype.refresh=function(){},t.prototype.setFilter=function(e){var t=e.index,r=e.filter;return s(this,void 0,void 0,function(){return o(this,function(e){switch(e.label){case 0:return[4,this._flushQueues()];case 1:return e.sent(),[2,this.setFilterBase(t,r)]}})})},t.prototype.setViewState=function(e){},t.prototype.onTileUpdate=function(e){var t=this,r=e.added,i=e.removed;this._started&&(i.forEach(function(e){return t._handleTileRemove(e)}),r.forEach(function(e){return t._handleTileAdd(e)}))},t.prototype.enableEvent=function(e){"data-received"===e.name&&(this._shouldPushDataReceived=e.value)},t.prototype._flushQueues=function(){var e=[];return this._tileDispatchMap.forEach(function(t){return e.push(t)}),e.reduce(function(e,t){return e.then(function(){return t.flush()})},l.resolve())},t.prototype._start=function(){var e=this;this._started||this._queryBuddies().then(function(){e._startWebSocket(),e.tileStore.tiles.forEach(function(t){return e._handleTileAdd(t)}),e._started=!0,e._updateActiveTiles(e.queryEngine)})},t.prototype._getService=function(){var e=n({},this.service.content,{f:"json"});return h(this.service.source,{query:e,responseType:"json"}).then(function(e){return e.data})},t.prototype._startWebSocket=function(){var e=this;this._getService().then(function(t){return e._createWebSocket(t)}).then(function(t){return e._setFilter(t)}).catch(function(e){return w.error(new p("stream-socket","Encountered an error while creating listening stream",e))})},t.prototype._destroyWebSocket=function(){this._websocket&&(this._websocket.onmessage=null,this._websocket.onerror=null,this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.close(),this.notifyChange("connectionStatus"))},t.prototype._createWebSocket=function(e){var t=this;return l.create(function(r){for(var i=e.streamUrls,n=i.filter(function(e){return"ws"===e.transport})[0],o=n.token,s=n.urls,u=null,a=null,c=0,h=s;c<h.length;c++){var p=h[c];-1!==p.indexOf("wss")?u=p:a=p}var d=(u||a)+"/subscribe?outSR="+t.spatialReference.wkid+(o?"&token="+o:""),l=new WebSocket(d);l.onopen=function(){t.notifyChange("connectionStatus"),r(l)},l.onmessage=t._handleWebSocketMessage.bind(t),l.onclose=t._handleWebSocketClose.bind(t),t._destroyWebSocket(),t._websocket=l})},t.prototype._setFilter=function(e){var t=this,r={},i=this.processor.queryInfo.outFields;return this.configuration.serviceFilter.geometry&&(r.geometry=JSON.stringify(this.configuration.serviceFilter.geometry)),this.configuration.serviceFilter.where&&(r.where=this.configuration.serviceFilter.where),i.length/this.service.fields.length>=.75&&(r.outFields=i.join(",")),r.geometry||r.where||r.outFields||l.resolve(),l.create(function(i,n){var o=e.onmessage;e.onmessage=function(r){var s=JSON.parse(r.data);s.filter&&(e.onmessage=o,s.error?(t.set("errorString","Could not set service filter - "+s.error),n(new p("stream-socket-service-filter",t.errorString,{activeServiceFilter:s.filter}))):i())},e.send(JSON.stringify({filter:r}))})},t.prototype._reconnectWebSocket=function(e){this.set("errorString","Lost websocket connection - "+e+", attempting to reconnect"),w.error(new p("stream-socket",this.errorString)),this._startWebSocket()},t.prototype._handleWebSocketClose=function(e){var t=e.code;if(this.notifyChange("connectionStatus"),1001===t||t>=4e3){var r=this._getErrorMessage(t);this.set("errorString","Encountered a service error "+t+" - "+r+", terminating websocket connection"),w.error(new p("stream-socket",this.errorString))}else{if(1e3===t)return;this._reconnectWebSocketT(t)}},t.prototype._getErrorMessage=function(e){switch(e){case 1001:return"Service is going away";case 4400:return"Invalid URL parameters. Check filter properties.";case 4401:case 4403:return"Not authorized";case 4404:return"Service not found";default:return"Encountered error code "+e}},t.prototype._handleWebSocketMessage=function(e){try{var t=JSON.parse(e.data);if(this._normalizeFeatureId(t),this._enrichFeature(t),!t.geometry&&!t.centroid)return void w.error(new p("stream-socket","Found malformed feature"));this._shouldPushDataReceived&&this.remoteClient.invoke("emitEvent",{name:"data-received",event:t});var r=g.convertFromFeature(t,this.service.geometryType,!1,!1,this.service.objectIdField);this._featureIds.push(r.attributes[this.service.objectIdField]),this._tempQueryEngine.featureStore.add(r)}catch(e){w.error(new p("stream-socket","Encountered an error when parsing socket message",e))}},t.prototype._handleTileAdd=function(e){if(this._tileDispatchMap.has(e.id)){var t=this._tileDispatchMap.get(e.id);t.up()}else{var t=new F.default;this._tileDispatchMap.set(e.id,t)}this._queryTileFeatures(e,!0,this.queryEngine)},t.prototype._handleTileRemove=function(e){this._tileDispatchMap.get(e.id).destroy(),this._tileDispatchMap.delete(e.id)},t.prototype._checkForUpdates=function(){if(this._started){var e=this._getFeaturesToAdd(),t=this._getFeaturesToRemove(),r=[];e.featureStore.forEach(function(e){return r.push(e)}),t.featureStore.addMany(r),this.processor.supportsTileUpdates?(this._updateActiveTiles(e,t),e.featureStore.transferAll(this.queryEngine.featureStore)):(e.featureStore.transferAll(this.queryEngine.featureStore),this._repushActiveTiles(e,t)),t.destroy()}},t.prototype._anyUpdatesQueued=function(){return u.from(this._tileDispatchMap).some(function(e){e[0];return e[1].hasAction()})},t.prototype._updateActiveTiles=function(e,t){for(var r=0,i=this.tileStore.tiles;r<i.length;r++){var n=i[r];this._queryTileFeatures(n,!1,e,t)}},t.prototype._repushActiveTiles=function(e,t){for(var r=0,i=this.tileStore.tiles;r<i.length;r++){var n=i[r];this._queryTileFeatures(n,!0,this.queryEngine)}},t.prototype._getFeaturesToAdd=function(){return this._tempQueryEngine},t.prototype._getFeaturesToRemove=function(){var e=this.configuration.purgeOptions,t=e.displayCount,r=e.age,i=this._createQueryEngine();return this._purgeByDisplayCount(t,i),this._purgeByAge(r,i),i},t.prototype._purgeByDisplayCount=function(e,t){if(null!=e){var r=this.queryEngine.featureStore.numFeatures;if(r>e){var i=r-e,n=this._featureIds.splice(0,i);this.queryEngine.featureStore.transferIds(t.featureStore,n)}}},t.prototype._purgeByAge=function(e,t){if(null==e)return l.resolve();var r=60*e*1e3,i=Date.now()-r,n=this.service.timeInfo.startTimeField,o=function(e){return e.attributes[n]<i};this.queryEngine.featureStore.transferIf(t.featureStore,o)},t.prototype._queryTileFeatures=function(e,t,r,i){var n=this,o={hasZ:!1,hasM:!1,transform:{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]}},s=this.processor.queryInfo,u=s.returnCentroid,a=s.returnGeometry,c=s.pixelBuffer,h=this._getFilterFlags.bind(this),p={returnCentroid:u,returnGeometry:a,pixelBuffer:c},d=this._tileDispatchMap.get(e.id),l=r&&r.executeTileQuery(e,p,h),f=l&&l.features,y=i&&i.executeTileQueryForIds(e,p),g=function(){return n.processor.onTileData(e,{addOrUpdate:f,remove:y,clear:t,transformParams:o})};d.enqueue(g)},t.prototype._queryBuddies=function(){var e=this,t=this.service.buddyLayers,r=t.relatedFeatures,i=t.keepLatestArchive,n=this._queryBuddy(r),o=this._queryBuddy(i);return l.all([n,o]).then(function(t){var r=t[0],i=t[1];return e._addBuddyFeatures(r,i)})},t.prototype._queryBuddy=function(e){if(!e)return l.resolve();var t=this._createQuery(this.processor.queryInfo);return m.executeQuery(e.source,t).then(function(e){return e.data})},t.prototype._addBuddyFeatures=function(e,t){e&&this._setEnrichmentData(e),t&&this._addFeatures(t)},t.prototype._setEnrichmentData=function(e){for(var t=e.features,r=new a.default,i=this.service.buddyLayers.relatedFeatures.joinField,n=0,o=t;n<o.length;n++){var s=o[n];i===this.service.objectIdField&&"string"==typeof i&&(s.attributes[i]=E(s.attributes[i])),r.set(s.attributes[i],s)}this._enrichmentData=r},t.prototype._enrichFeature=function(e){if(!this._enrichmentData)return e;var t=this.service.buddyLayers.relatedFeatures.joinField,r=e.attributes[t];if(this._enrichmentData.has(r)){var i=this._enrichmentData.get(r),n=i.attributes,o=i.geometry;for(var s in n)e.attributes[s]=n[s];o&&(e.geometry=o)}return e},t.prototype._normalizeFeatureId=function(e){var t;t="__OBJECTID"===this.service.objectIdField?this._idCounter++:"string"==typeof e.attributes[this.service.objectIdField]?E(e.attributes[this.service.objectIdField]):e.attributes[this.service.objectIdField],e.attributes[this.service.objectIdField]=t},t.prototype._addFeatures=function(e){e.objectIdFieldName=this.service.objectIdField;for(var t=0,r=e.features;t<r.length;t++){var i=r[t];this._normalizeFeatureId(i),this._enrichFeature(i)}var n=g.convertFromFeatureSet(e).features;this.queryEngine.featureStore.addMany(n)},t.prototype._createQuery=function(e){var t=new b,r=e.historicMoment,i=e.outFields;return t.historicMoment=null!=r?new Date(r):null,t.outFields=i.length/this.service.fields.length>=.75?["*"]:i,t.returnExceededLimitFeatures=!0,t.returnGeometry=!0,t.gdbVersion=e.gdbVersion,t.returnCentroid=e.returnCentroid,t.orderByFields=e.orderByFields,t.outSpatialReference=this.spatialReference,t.where=this.configuration.filter.where||"1=1",this.configuration.filter.geometry&&(t.geometry=c.Extent.fromJSON(this.configuration.filter.geometry)),t},t.prototype._createQueryEngine=function(){var e=this.processor.queryInfo,t=e.definitionExpression,r=e.gdbVersion,i=e.historicMoment;return new _.default({definitionExpression:t,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,gdbVersion:r,historicMoment:null!=i&&new Date(i),featureStore:new v.default({geometryType:this.service.geometryType,hasM:!1,hasZ:!1}),timeInfo:this.service.timeInfo})},t.prototype._resetTempStore=function(){this._tempQueryEngine&&this._tempQueryEngine.destroy(),this._tempQueryEngine=this._createQueryEngine()},t.prototype._switchProcessor=function(e,t){this.queryEngine&&this.queryEngine.destroy(),this._set("queryEngine",this._createQueryEngine()),this._resetTempStore(),this._start(),this.notifyChange("updating")},i([y.property()],t.prototype,"service",void 0),i([y.property({readOnly:!0})],t.prototype,"queryEngine",void 0),i([y.property()],t.prototype,"updating",null),i([y.property()],t.prototype,"connectionStatus",null),i([y.property()],t.prototype,"errorString",void 0),t=i([y.subclass()],t)}(y.declared(S.default));t.default=k});