// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/assignHelper","../../../../core/Error","../../../../core/promiseUtils","../../../../geometry/support/jsonUtils","../../../../geometry/support/spatialReferenceUtils","../../featureConversionUtils","../../data/FeatureStore","../../data/projectionSupport","../../data/QueryEngine","./clientSideDefaults","../../../support/fieldType","../../../support/fieldUtils"],function(e,t,i,r,n,s,a,u,l,o,d,p,f,y,c){function h(e){return a.isPoint(e)?null!=e.z:!!e.hasZ}function m(e){return a.isPoint(e)?null!=e.m:!!e.hasM}Object.defineProperty(t,"__esModule",{value:!0});var g=u.WGS84,b={xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:u.WGS84},v={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!1,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0}},F=function(){function e(){this.code=null,this.description=null}return e}(),I=function(){function e(e){this.error=new F,this.globalId=null,this.objectId=null,this.success=!1,this.uniqueId=null,this.error.description=e}return e}(),_=function(){function e(e){this.globalId=null,this.success=!0,this.objectId=this.uniqueId=e}return e}(),j=function(){function e(){this._queryEngine=null,this._nextObjectId=null,this._fieldsMap=new Map}return e.prototype.destroy=function(){this._queryEngine&&this._queryEngine&&this._queryEngine.destroy(),this._queryEngine=this._requiredFieldNames=this._fieldsMap=this._createDefaultAttributes=null},e.prototype.load=function(e){var t=this,i=[],a=e.features,u=this._inferLayerProperties(a,e.fields),l=e.fields||[],h=null!=e.hasM?e.hasM:u.hasM,m=null!=e.hasZ?e.hasZ:u.hasZ,F=!e.spatialReference&&!u.spatialReference,I=F?g:e.spatialReference||u.spatialReference,_=F?b:null,j=e.geometryType||u.geometryType,E=e.objectIdField||u.objectIdField,T=e.timeInfo;if(F&&i.push({type:"feature-layer:spatial-reference-not-found",message:"Spatial reference not provided or found in features. Defaults to WGS84"}),!j)return s.reject(new n("feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features"));if(!E)return s.reject(new n("feature-layer:missing-property","objectIdField not set and couldn't be found in the provided fields"));if(u.objectIdField&&E!==u.objectIdField&&(i.push({type:"feature-layer:duplicated-oid-field",message:'Provided objectIdField "'+E+'" doesn\'t match the field name "'+u.objectIdField+'", found in the provided fields'}),E=u.objectIdField),E&&!u.objectIdField){var q=null;l.some(function(e){return e.name===E&&(q=e,!0)})?(q.type="esriFieldTypeOID",q.editable=!1,q.nullable=!1):l.unshift({alias:E,name:E,type:"esriFieldTypeOID",editable:!1,nullable:!1})}for(var x=0,R=l;x<R.length;x++){var w=R[x];if(null==w.name&&(w.name=w.alias),null==w.alias&&(w.alias=w.name),!w.name)return s.reject(new n("feature-layer:invalid-field-name","field name is missing",{field:w}));if(w.name===E&&(w.type="esriFieldTypeOID"),-1===y.kebabDict.jsonValues.indexOf(w.type))return s.reject(new n("feature-layer:invalid-field-type",'invalid type for field "'+w.name+'"',{field:w}))}var D={};this._requiredFieldNames=[];for(var M=0,S=l;M<S.length;M++){var w=S[M];if("esriFieldTypeOID"!==w.type&&"esriFieldTypeGlobalID"!==w.type){w.editable=null==w.editable||!!w.editable,w.nullable=null==w.nullable||!!w.nullable;var O=c.getFieldDefaultValue(w);w.nullable||void 0!==O?D[w.name]=O:this._requiredFieldNames.push(w.name)}this._fieldsMap.set(w.name.trim(),w),this._fieldsMap.set(w.name.trim().toLowerCase(),w)}if(this._createDefaultAttributes=f.createDefaultAttributesFunction(D,E),T){if(T.startTimeField){var A=this._fieldsMap.get(T.startTimeField.toLowerCase());A?(T.startTimeField=A.name,A.type="esriFieldTypeDate"):T.startTimeField=null}if(T.endTimeField){var C=this._fieldsMap.get(T.endTimeField.toLowerCase());C?(T.endTimeField=C.name,C.type="esriFieldTypeDate"):T.endTimeField=null}if(T.trackIdField){var Q=this._fieldsMap.get(T.trackIdField.toLowerCase());Q?T.trackIdField=Q.name:(T.trackIdField=null,i.push({type:"feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:T}}))}T.startTimeField||T.endTimeField||(i.push({type:"feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing or invalid",details:{timeInfo:T}}),T=null)}var k={warnings:i,featureErrors:[],layerDefinition:r({},v,{drawingInfo:f.createDrawingInfo(j),templates:f.createDefaultTemplate(D),extent:_,geometryType:j,objectIdField:E,fields:l,hasZ:!!m,hasM:!!h,timeInfo:T}),assignedObjectIds:{}};if(this._queryEngine=new p.default({fields:l,geometryType:j,hasM:h,hasZ:m,objectIdField:E,spatialReference:I,featureStore:new o.default({geometryType:j,hasM:h,hasZ:m}),timeInfo:T}),!a||!a.length)return this._nextObjectId=1,s.resolve(k);var P=a.reduce(function(e,t){var i=t.attributes&&t.attributes[E];return null==i||isNaN(i)||!isFinite(i)?e:Math.max(e,i)},0);return this._nextObjectId=1+P,d.checkProjectionSupport(a,I).then(function(){return t._loadInitialFeatures(k,a)})},e.prototype.applyEdits=function(e){var t=this,i=this._queryEngine.spatialReference;return d.checkProjectionSupport(e.adds,i).then(function(){return d.checkProjectionSupport(e.updates,i)}).then(function(){return t._applyEdits(e)})},e.prototype.queryFeatures=function(e){return this._queryEngine.executeQuery(e)},e.prototype.queryFeatureCount=function(e){return this._queryEngine.executeQueryForCount(e)},e.prototype.queryObjectIds=function(e){return this._queryEngine.executeQueryForIds(e)},e.prototype.queryExtent=function(e){return this._queryEngine.executeQueryForExtent(e)},e.prototype._inferLayerProperties=function(e,t){for(var i=void 0,r=void 0,n=null,s=null,u=null,l=0,o=e;l<o.length;l++){var d=o[l],p=d.geometry;if(p&&(n||(n=a.getJsonType(p)),s||(s=p.spatialReference),null==i&&(i=h(p)),null==r&&(r=m(p)),n&&s&&null!=i&&null!=r))break}if(t&&t.length){var f=null;t.some(function(e){var t="esriFieldTypeOID"===e.type,i=!e.type&&e.name&&"objectid"===e.name.toLowerCase();return f=e,t||i})&&(u=f.name)}return{geometryType:n,spatialReference:s,objectIdField:u,hasM:r,hasZ:i}},e.prototype._loadInitialFeatures=function(e,t){for(var i=this._queryEngine,r=i.geometryType,n=i.hasM,s=i.hasZ,u=i.objectIdField,o=i.spatialReference,p=i.featureStore,f=[],y=0,c=t;y<c.length;y++){var h=c[y];if(null!=h.uid&&(e.assignedObjectIds[h.uid]=-1),h.geometry&&r!==a.getJsonType(h.geometry))e.featureErrors.push(new I("Incorrect geometry type."));else{var m=this._createDefaultAttributes(),g=this._mixAttributes(m,h.attributes,!0);g?e.featureErrors.push(g):(this._assignObjectId(m,h.attributes,!0),h.attributes=m,null!=h.uid&&(e.assignedObjectIds[h.uid]=h.attributes[u]),h.geometry&&(h.geometry=d.project(h.geometry,h.geometry.spatialReference,o)),f.push(h))}}if(p.addMany(l.convertFromFeatures([],f,r,s,n,u)),e.layerDefinition.extent=this._queryEngine.fullExtent,e.layerDefinition.timeInfo){var b=this._queryEngine.timeExtent,v=b.start,F=b.end;e.layerDefinition.timeInfo.timeExtent=[v,F]}return e},e.prototype._applyEdits=function(e){var t=e.adds,i=e.updates,r=e.deletes,n={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t&&t.length&&this._applyAddEdits(n,t),i&&i.length&&this._applyUpdateEdits(n,i),r&&r.length){for(var s=0,a=r;s<a.length;s++){var u=a[s];n.deleteResults.push(new _(u))}this._queryEngine.featureStore.removeManyById(r)}return{fullExtent:this._queryEngine.fullExtent,featureEditResults:n}},e.prototype._applyAddEdits=function(e,t){for(var i=e.addResults,r=this._queryEngine,n=r.geometryType,s=r.hasM,u=r.hasZ,o=r.objectIdField,p=r.spatialReference,f=r.featureStore,y=[],c=0,h=t;c<h.length;c++){var m=h[c];if(m.geometry&&n!==a.getJsonType(m.geometry))i.push(new I("Incorrect geometry type."));else{var g=this._createDefaultAttributes(),b=this._mixAttributes(g,m.attributes);if(b)i.push(b);else{if(this._assignObjectId(g,m.attributes),m.attributes=g,null!=m.uid){var v=m.attributes[o];e.uidToObjectId[m.uid]=v}m.geometry&&(m.geometry=d.project(m.geometry,m.geometry.spatialReference,p)),y.push(m),i.push(new _(m.attributes[o]))}}}f.addMany(l.convertFromFeatures([],y,n,u,s,o))},e.prototype._applyUpdateEdits=function(e,t){for(var i=e.updateResults,r=this._queryEngine,n=r.geometryType,s=r.hasM,u=r.hasZ,o=r.objectIdField,p=r.spatialReference,f=r.featureStore,y=0,c=t;y<c.length;y++){var h=c[y],m=h.attributes,g=h.geometry,b=m&&m[o];if(null!=b)if(f.has(b)){var v=l.convertToFeature(f.getFeature(b),n,u,s);if(g){if(n!==a.getJsonType(g)){i.push(new I("Incorrect geometry type."));continue}v.geometry=d.project(g,g.spatialReference,p)}if(m){var F=this._mixAttributes(v.attributes,m);if(F){i.push(F);continue}}f.add(l.convertFromFeature(v,n,u,s,o)),i.push(new _(b))}else i.push(new I("Feature with object id "+b+" missing"));else i.push(new I("Identifier field "+o+" missing"))}},e.prototype._assignObjectId=function(e,t,i){void 0===i&&(i=!1);var r=this._queryEngine.objectIdField;i&&t&&isFinite(t[r])?e[r]=t[r]:e[r]=this._nextObjectId++},e.prototype._mixAttributes=function(e,t,i){void 0===i&&(i=!1);for(var r in t){var n=c.sanitizeNullFieldValue(t[r]),s=this._fieldsMap.get(r)||this._fieldsMap.get(r.toLowerCase());if(s&&(i||s.editable)){var a=c.validateFieldValue(s,n);if(a)return new I(c.validationErrorToString(a,s,n));e[s.name]=n}}for(var u=0,l=this._requiredFieldNames;u<l.length;u++){var o=l[u];if(void 0===e[o])return new I('missing required field "'+o+'"')}return null},e}();t.default=j});