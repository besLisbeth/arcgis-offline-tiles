define(["require","exports","../Error","../has","../promiseUtils","./Connection","./RemoteClient","./WorkerOwner"],function(n,o,u,e,c,t,r,i){function a(){if(d)return d;for(var n=f+s,t=[],e=0;e<n;e++)!function(e){var n=i.create(e).then(function(n){return h[e]=n});t.push(n)}(e);return d=c.all(t).then(function(){})}Object.defineProperty(o,"__esModule",{value:!0}),o.Connection=t,o.RemoteClient=r;var l=e("host-browser")?navigator.hardwareConcurrency:0;l||(l=e("safari")&&e("mac")||e("trident")?8:2);var f=e("esri-workers-debug")?1:Math.max(1,Math.ceil(l/2)),s=e("esri-workers-debug")?1:Math.max(1,Math.floor(l/2)),m=0,h=[];o.initialize=function(){a()},o.openWithPorts=function(n,e){return new o.Connection(n.map(function(n){return new o.RemoteClient(n,e,{})}))},o.open=function(t,e){if(void 0===e&&(e={}),"string"!=typeof t)return c.reject(new u("workers:undefined-module","modulePath is missing"));var r=e.strategy||"distributed";if("local"!==r)return a().then(function(){if("dedicated"!==r)return c.all(h.map(function(n){return n.open(t)})).then(function(n){return new o.Connection(n.map(function(n){return new o.RemoteClient(n,e.client,e)}))});var n=f+m++;return m%=s,h[n].open(t).then(function(n){return new o.Connection([new o.RemoteClient(n,e.client,e)])})});var i=e.client;return c.create(function(e){return n([t],function(n){i=i||n,e(o.RemoteClient.connect(n))})}).then(function(n){return new o.Connection([new o.RemoteClient(n,i,e)])})},o.terminate=function(){d&&(d.cancel(),d=null);for(var n=0;n<h.length;n++)h[n]&&h[n].terminate();h.length=0};var d=null});