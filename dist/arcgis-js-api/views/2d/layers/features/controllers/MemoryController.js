// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../geometry","../../../../../core/Error","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/workers","../../../../../core/accessorSupport/decorators","../../../../../geometry/support/spatialReferenceUtils","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/support/FeatureProcessing","../../../../../tasks/support/QuantizationParameters","../../../../../tasks/support/Query","../../../engine/webgl/Utils","./BaseController","../support/TileUpdateQueue"],function(e,t,r,o,i,s,n,u,a,p,l,c,f,h,y,d,m,g,v,_,x,b){Object.defineProperty(t,"__esModule",{value:!0});var F=p.getLogger("esri.views.2d.layers.features.controllers.MemoryController"),w=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="memory",t._processingInMainThread=!1,t}return r(t,e),t.prototype.initialize=function(){var e=this;this._tileQueue=new b.default({tileInfoView:this.tileStore.tileScheme,process:function(t,r){return e._fetchFeatureSet(t,r)}}),this._memorySource=f.openWithPorts(this.service.source,{client:this}),this.handles.add(this.watch("processor",this._switchProcessor.bind(this)))},t.prototype.destroy=function(){this._memorySource.close(),this._memorySource=null,this._tileQueue.clear(),this._tileQueue.pause()},Object.defineProperty(t.prototype,"processing",{get:function(){return m.fromWorker(this.configuration.processing)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._tileQueue.updating},enumerable:!0,configurable:!0}),t.prototype.onEdits=function(e){this.refresh()},t.prototype.queryFeatures=function(e){return this._memorySource.invoke("queryFeatures",e)},t.prototype.queryFeatureCount=function(e){return this._memorySource.invoke("queryFeatureCount",e)},t.prototype.queryObjectIds=function(e){return this._memorySource.invoke("queryObjectIds",e)},t.prototype.queryExtent=function(e){return this._memorySource.invoke("queryExtent",e)},t.prototype.redraw=function(){this.refresh()},t.prototype.refresh=function(){this._tileQueue.refresh();for(var e=0,t=this.tileStore.tiles;e<t.length;e++){var r=t[e];this._tileQueue.push(r.id,r.updateTimestamp)}},t.prototype.setViewState=function(e){this._tileQueue.state=e},t.prototype.setFilter=function(e){var t=e.index,r=e.filter;return n(this,void 0,void 0,function(){var e;return s(this,function(o){switch(o.label){case 0:return[4,this.setFilterBase(t,r)];case 1:return e=o.sent(),this.processor&&!this.processor.supportsTileUpdates&&this.redraw(),l.isNone(e)?(F.error(new a("featurelayer-controller:required-fields-error","Tried to set filter but was unable to find required fields")),[2,{show:[],hide:[]}]):[2,e]}})})},t.prototype.onTileUpdate=function(e){this._tileQueue.pause();for(var t=0,r=e.removed;t<r.length;t++){var o=r[t];this._tileQueue.cancel(o.id)}for(var i=0,s=e.added;i<s.length;i++){var o=s[i];this._tileQueue.push(o.id,o.updateTimestamp)}this.processor&&this._tileQueue.resume()},t.prototype._switchProcessor=function(e,t){this.refresh(),e&&this._tileQueue.resume()},t.prototype._fetchFeatureSet=function(e,t){var r=this,o=this.tileStore.get(e),i=this.processor.queryInfo;return this._query(o,i).then(function(e){return r._setFilterFlags(e)}).then(function(e){return r._wrapPoints(e,i)}).then(function(e){return r._sortFeatures(e,i)}).then(function(e){return e.features.length?e:null}).then(function(e){return o.updateTimestamp=t,r.processor.onTileData(o,{addOrUpdate:e&&e.features,clear:!0,transformParams:e&&_.getTransformParams(e)})}).catch(function(e){return o.updateTimestamp=t,"cancel"!==e.dojoType&&(r.processor.onTileError(o,e.message),F.error("query-error",{error:e})),c.reject(e)})},t.prototype._query=function(e,t){var r=this,o=new v,i=this._getQuantizationParameters(e),s=t.pixelBuffer*e.resolution,n=e.bounds.slice();return n[0]-=s,n[1]-=s,n[2]+=s,n[3]+=s,o.outFields=this.processor.queryInfo.outFields,o.where=this.processor.queryInfo.definitionExpression||"1=1",o.geometry=new u.Extent({xmin:n[0],ymin:n[1],xmax:n[2],ymax:n[3],spatialReference:this.spatialReference}),this.service.capabilities.query.supportsQuantization?(o.quantizationParameters=i,"esriGeometryPolyline"===this.service.geometryType&&(o.maxAllowableOffset=i.tolerance)):o.maxAllowableOffset=i.tolerance,o.resultType="tile",o.returnExceededLimitFeatures=!1,o.returnGeometry=!0,o.returnCentroid=t.returnCentroid,o.orderByFields=t.orderByFields,this.queryFeatures(o.toJSON()).then(function(e){return t.returnCentroid?e.features=e.features.filter(function(e){return null!=e.geometry&&null!=e.centroid}):e.features=e.features.filter(function(e){return null!=e.geometry}),e}).then(function(e){return r._applyProcessing(e)})},t.prototype._applyProcessing=function(e){var t=this.processing;if(!t)return e;if(this._processingInMainThread)return this.remoteClient.invoke("executeProcessing",{featureSet:e});try{var r=t.process(e,t.options);return r||c.reject(new a("FeatureLayer","invalid processing.process() method, returns nothing"))}catch(t){return this._processingInMainThread=!0,this.remoteClient.invoke("executeProcessing",{featureSet:e})}},t.prototype._getQuantizationParameters=function(e){return new g.default({mode:"view",originPosition:"lower-left",tolerance:e.resolution,extent:new u.Extent({xmin:e.bounds[0],ymin:e.bounds[1],xmax:e.bounds[2],ymax:e.bounds[3],spatialReference:this.spatialReference})})},t.prototype._wrapPoints=function(e,t){if(0===e.features.length)return e;var r=t.returnCentroid,o=t.pixelBuffer,s=e.geometryType,n=e.spatialReference,u=e.transform;if("esriGeometryPoint"!==s&&"esriGeometryMultipoint"!==s&&!r||!y.isWrappable(n))return e;var a=e.features,p=y.getInfo(n),l=Math.round((p.valid[1]-p.valid[0])/u.scale[0]);if(512===l){for(var c=[],f=0,h=a;f<h.length;f++){var d=h[f],m=d.geometry,g=d.attributes;if(m)if(m.x<o){var v={geometry:i({},m),attributes:g};v.geometry.x+=l,c.push(v)}else if(m.x>512-o){var v={geometry:i({},m),attributes:g};v.geometry.x-=l,c.push(v)}}a.push.apply(a,c)}else for(var _=0,x=a;_<x.length;_++){var m=x[_].geometry;m&&(m.x<-o?m.x+=l:m.x>512+o&&(m.x-=l))}return e},t.prototype._sortFeatures=function(e,t){var r=t.orderByFields;if(r){var o=r[0].split(" "),i=o[0];"DESC"===o[1]&&e.features.sort(function(e,t){return t.attributes[i]-e.attributes[i]})}return e},t.prototype._setFilterFlags=function(e){var t=d.convertFromFeatureSet(e,this.service.objectIdField);this.hasGeometryFilter()&&(t=d.hydrateOptimizedFeatureSet(t));for(var r=t.features,o=0;o<r.length;o++)e.features[o].filterFlags=this._getFilterFlags(r[o]);return e},o([h.property()],t.prototype,"_tileQueue",void 0),o([h.property({readOnly:!0,dependsOn:["configuration"]})],t.prototype,"processing",null),o([h.property({dependsOn:["_tileQueue.updating"]})],t.prototype,"updating",null),t=o([h.subclass()],t)}(h.declared(x.default));t.default=w});