// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../renderers","../../../../../core/Accessor","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/screenUtils","../../../../../core/accessorSupport/decorators","../../../../../geometry/support/aaBoundingRect","../../../../../renderers/support/diffUtils","../../../../../support/arcadeUtils","../../../engine/webgl/rendererInfoUtils","../../../engine/webgl/visualVariablesUtils","../../../engine/webgl/WGLFeatureView","../../../engine/webgl/WGLTile","./BaseTileRenderer"],function(e,t,i,r,n,o,a,l,s,u,f,p,c,d,v,h,g,y,b){function V(e){for(var t in e.diff){var i=e.diff[t];if("partial"===i.type&&V(i))return!0;if("complete"===i.type&&"valueExpression"===t)return!0}return!1}function w(e){for(var t in e.diff){var i=e.diff[t];if("collection"===i.type){if(0!==i.changed.length||0!==i.added.length||0!==i.removed.length)return!0}else{if("visualVariables"!==t&&"authoringInfo"!==t)return!0;if("visualVariables"===t){if("complete"===i.type)return!0;if(V(i))return!0}}}return!1}function m(e){if(!("visualVariables"in e&&e.visualVariables&&e.visualVariables.length))return e;var t=e.clone(),i=t.visualVariables.map(function(e){return I(e)?R(e):e});return t.visualVariables=i,t}function I(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}function R(e){return e.stops=x(e.type,e.stops),e}function T(e,t,i){return(1-i)*e+i*t}function F(e,t){for(var i=t[0],r=t.slice(1),n=r.pop(),o=r[0].value,a=r[r.length-1].value,l=(a-o)/C,s=[],f=o;f<a;f+=l){for(var p=0;f>=r[p].value;)p++;var c=r[p],d=t[p-1],v=f-d.value,h=c.value===d.value?1:v/(c.value-d.value);if("color"===e){var g=r[p],y=t[p-1],b=g.color.clone();b.r=T(y.color.r,b.r,h),b.g=T(y.color.g,b.g,h),b.b=T(y.color.b,b.b,h),b.a=T(y.color.a,b.a,h),s.push({value:f,color:b,label:g.label})}else if("size"===e){var V=r[p],w=t[p-1],m=u.toPt(V.size),I=u.toPt(w.size),R=T(I,m,h);s.push({value:f,size:R,label:V.label})}else{var F=r[p],S=t[p-1],x=T(S.opacity,F.opacity,h);s.push({value:f,opacity:x,label:F.label})}}return[i].concat(s,[n])}function S(e){for(var t=e[0],i=e.slice(1),r=i.pop();i.length>C;){for(var n=0,o=0,a=1;a<i.length;a++){var l=i[a-1],s=i[a],u=Math.abs(s.value-l.value);u>o&&(o=u,n=a)}i.splice(n,1)}return[t].concat(i,[r])}function x(e,t){return t.length<=N?t:(O.warn("Found "+t.length+" Visual Variable stops, but MapView only supports "+N+". Displayed stops will be simplified."),t.length>2*N?F(e,t):S(t))}Object.defineProperty(t,"__esModule",{value:!0});var O=l.getLogger("esri.views.2d.layers.features.tileRenderer.SymbolTileRenderer"),N=8,C=N-2,E=function(e){function t(t){return e.call(this)||this}return i(t,e),t.prototype.createTile=function(e){var t=p.create();return this.tileInfoView.getTileBounds(t,e),new y(e,t)},t.prototype.disposeTile=function(e){this.featuresView.removeChild(e)},t.prototype.updateHighlight=function(){this.featuresView.updateHighlight()},t.prototype.hitTest=function(e,t){return this.featuresView.hitTest(e,t)},t.prototype.supportsRenderer=function(e){return null!=e&&-1!==["simple","class-breaks","unique-value","dot-density"].indexOf(e.type)},t.prototype.getProcessorConfiguration=function(){var e=this.layer,t=e.definitionExpression,i=e.gdbVersion,r=e.historicMoment,n=e.labelingInfo,o=this.layerView.availableFields,a=m(this.layer.renderer);return{type:"symbol",renderer:a.toJSON(),devicePixelRatio:window.devicePixelRatio||1,definitionExpression:t,availableFields:o,gdbVersion:i,historicMoment:r&&r.getTime(),labelingInfo:n&&n.map(function(e){return e.toJSON()}),hasGeometryExpr:d.hasGeometryOperations(a)||n&&n.some(function(e){return d.hasGeometryOperations(e)})}},t.prototype.needsProcessorReconfiguration=function(e){var t=this.wouldClear(e),i=this.configuration;return this.configuration=e,t||i.definitionExpression!==e.definitionExpression},t.prototype.wouldClear=function(e){var t=this.configuration;if(!t||t.availableFields.join()!==e.availableFields.join()||c.diff(t.labelingInfo,e.labelingInfo))return!0;var i=this.configuration&&o.fromJSON(this.configuration.renderer)||null,r=e&&o.fromJSON(e.renderer)||null;if(r&&"dot-density"===r.type){return(i&&i.getControllerHash())!==(r&&r.getControllerHash())}var n=c.diff(i,r);if(s.isNone(n))return!1;switch(n.type){case"complete":return!0;case"partial":if(w(n))return!0;if(n.diff.visualVariables){var a=this.featuresView.visualVariablesInfo,l=this.tileInfoView.tileInfo.spatialReference,u={fields:this.layer.fields.map(function(e){return e.toJSON()})},f=v.getNormalizedRenderer(r,l,u),p=h.convertVisualVariables(f.visualVariables).vvFields;return!!c.diff(a.vvFields,p)}}},t.prototype.clear=function(){this.featuresView.disposeWebGLResources()},t.prototype.applyConfiguration=function(e){var t=o.fromJSON(e.renderer),i={fields:this.layer.fields.map(function(e){return e.toJSON()})},r=v.getNormalizedRenderer(t,this.tileInfoView.tileInfo.spatialReference,i);this.configuration=e,this.featuresView.visualVariablesInfo=h.convertVisualVariables(r.visualVariables)},t.prototype.install=function(e){var t=new g.default({tileInfoView:this.tileInfoView,layer:this.layer,layerView:this.layerView});this.featuresView=t,e.addChild(t)},t.prototype.uninstall=function(e){e.removeChild(this.featuresView),this.featuresView=null},t.prototype.onTileData=function(e){var t=this.tiles.get(e.tileKey);t&&this.featuresView.onTileData(t,e.data)},t.prototype.onTileError=function(e){var t=this.tiles.get(e.tileKey);t&&this.featuresView.onTileError(t)},t.prototype.getMaterialItems=function(e){return this.featuresView.getMaterialItems(e)},t.prototype.setFilterFlag=function(e,t,i,r){this.featuresView.setFilterFlag(e,t,i,r)},t=r([f.subclass()],t)}(f.declared(a,b.default));t.default=E});