// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.11/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../arcade/Dictionary","../../../../../core/Error","../../../../../core/Logger","../../../../../core/MapPool","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators","../../../../../geometry/SpatialReference","../../../../../layers/support/LabelClass","../../../../../layers/support/labelFormatUtils","../../../../../renderers/support/jsonUtils","../../../engine/webgl/definitions","../../../engine/webgl/rendererInfoUtils","../../../engine/webgl/Utils","../../../engine/webgl/collisions/CollisionGrid","../../../engine/webgl/mesh/factories/matcherUtils","../../../engine/webgl/mesh/factories/WGLMeshFactory","../../../engine/webgl/mesh/templates/WGLTemplateStore","../../../engine/webgl/util/BidiText","./BaseProcessor","../support/pixelBuffering"],function(e,r,t,n,i,o,s,l,a,u,c,p,f,d,y,g,h,m,b,v,I,_,S,C,P){function O(e){return e&&("unique-value"===e.type||"class-breaks"===e.type)&&null!==e.backgroundFillSymbol}function w(e){var r=e&&e.getSymbols();return O(e)||r.some(function(e){return"simple-fill"===e.type||"picture-fill"===e.type})}function x(e,r){switch(e){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryMultipoint":return!0;case"esriGeometryPolygon":return w(r);default:return M.error(new s("mapview-invalid-type",e+" is not supported")),!1}}function E(e,r,t){t.has(e)||t.set(e,new Set);for(var n=t.get(e),i=r.length,o=0;o<i;o++){var s=r.charCodeAt(o);n.add(s)}}Object.defineProperty(r,"__esModule",{value:!0});var M=l.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor"),T=function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r._symbolToMosaicItemMap=new Map,r._visualSetPromises=new Map,r.type="symbol",r}return t(r,e),r.prototype.destroy=function(){this._visualSetPromises.forEach(function(e,r){e.cancel()}),this._visualSetPromises.clear(),this._symbolToMosaicItemMap.clear(),this.notifyChange("updating")},Object.defineProperty(r.prototype,"supportsTileUpdates",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"labelingInfo",{get:function(){return this.configuration&&this.configuration.labelingInfo?this.configuration.labelingInfo.map(function(e){return f.fromJSON(e)}):null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"labelClassInfos",{get:function(){var e=this;return this.labelingInfo?this.labelingInfo.map(function(r){return{labelOptions:d.getLabelingOptions(r,e.spatialReference),labelExpression:r.getLabelExpression(),labelClass:r}}):null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"hydrate",{get:function(){return m.createHydrateFactory(this.service.geometryType)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"factory",{get:function(){var e=this;if(!this.configuration)return null;var r=this.service,t=r.geometryType,n=r.objectIdField,i=r.fields,o=this.configuration,s=o.devicePixelRatio,l=o.hasGeometryExpr,a=function(r){return e.remoteClient.invoke("tileRenderer.getMaterialItems",r)},u=p.fromJSON(this.spatialReference),c={hasGeometryExpr:l,geometryType:t,fields:i,spatialReference:u},f=new _.default(a);return this._matcher=v.createMatcher(this.renderer,f,c),new I.default(t,n,this.renderer,c,s,u,f,this.labelingInfo,this.tileStore.tileScheme.tileInfo)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"queryInfo",{get:function(){var e=this.configuration,r=e.renderer,t=e.definitionExpression,n=e.availableFields,i=e.gdbVersion,o=e.historicMoment,s=this.service.geometryType,l=this._getReturnCentroid(this.rendererInfo.renderer),a=x(s,this.rendererInfo.renderer),u=null,c=r.visualVariables;c&&c.some(function(e){if("size"===e.type&&e.field&&!e.normalizationField)return u=[e.field+" DESC"],!0});var p=P.computePxBuffer(this.rendererInfo.renderer);return{definitionExpression:t,orderByFields:u,outFields:n,pixelBuffer:p,returnCentroid:l,returnGeometry:a,gdbVersion:i,historicMoment:o}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"renderer",{get:function(){return this.configuration?y.fromJSON(this.configuration.renderer):null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rendererInfo",{get:function(){return this.configuration?h.createRendererInfo(y.fromJSON(this.configuration.renderer),this.tileStore.tileScheme.spatialReference,{fields:this.service.fields}):null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"updating",{get:function(){return this._visualSetPromises.size>0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fields",{get:function(){return this.service.fields},enumerable:!0,configurable:!0}),r.prototype.onTileData=function(e,r){var t,n=this,i=r.addOrUpdate,o=r.remove,s=r.clear;t=i&&i.length?this._processFeatures(e,i,r.transformParams):u.resolve();var l=t.then(function(r){var t=r&&r.message||null,i=r&&r.transferList||null;return n.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:{addOrUpdate:t,remove:o,clear:s}},{transferList:i})}).catch(function(r){return n._handleError(e,r)});return this._visualSetPromises.set(e,l),l.then(function(){return n._cleanPromise(e)},function(){return n._cleanPromise(e)}),this.notifyChange("updating"),l},r.prototype.onTileError=function(e,r){var t=this,n=this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:e.id,error:r});return this._visualSetPromises.set(e,n),n.then(function(){return t._cleanPromise(e)},function(){return t._cleanPromise(e)}),this.notifyChange("updating"),n},r.prototype.onTileUpdate=function(e){for(var r=0,t=e.removed;r<t.length;r++){var n=t[r],i=this._visualSetPromises;if(!i.has(n))return;i.get(n).cancel(),i.delete(n),this.notifyChange("updating")}},r.prototype._cleanPromise=function(e){this._visualSetPromises.delete(e),this.notifyChange("updating")},r.prototype._processFeatures=function(e,r,t){var n=this;if(!r||!r.length)return u.resolve(null);var i=this.factory,o={viewingMode:"",scale:e.scale};return i.analyze(r,this._matcher,t,o).then(function(r){return n._getLabelMosaicItems(e,r,t).then(function(o){return n._writeFeatures(e,r,t,o,i)})})},r.prototype._writeFeatures=function(e,r,t,n,i){for(var o=i.createMeshData(r.length),s={viewingMode:"",scale:e.scale},l=this._symbolToMosaicItemMap,a=0,u=r;a<u.length;a++){var c=u[a];i.write(o,c,t,s,e.level,n,l)}return this._encodeDisplayData(o)},r.prototype._encodeDisplayData=function(e){var r={},t=new Array;return e.encode(r,t),{message:r,transferList:t}},r.prototype._handleError=function(e,r){if(r&&"cancel"!==r.dojoType)return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:e.id,error:r.message})},r.prototype._getReturnCentroid=function(e){function r(e){if(!e)return!1;var r=e.type;return"simple-marker"===r||"picture-marker"===r||"text"===r}if("esriGeometryPolygon"===this.service.geometryType&&this.labelingInfo)return!0;if("esriGeometryPolygon"!==this.service.geometryType)return!1;switch(e.type){case"simple":return r(e.symbol);case"unique-value":return r(e.defaultSymbol)||e.uniqueValueInfos.some(function(e){return r(e.symbol)});case"class-breaks":return r(e.defaultSymbol)||e.classBreakInfos.some(function(e){return r(e.symbol)});default:return!0}},r.prototype._getLabelMosaicItems=function(e,r,t){var n=a.acquire(),i=this._createLabelFeatures(e.scale,r,n,t),o=this._symbolToMosaicItemMap,s=a.acquire(),l=[],c=0;return n.forEach(function(e,r){if(o.has(r.id)){var t=o.get(r.id),n=t.glyphMosaicItems,i=[];e.forEach(function(e){(n&&n.length<e||!n[e])&&(i[e]=e)}),i.length>0&&(s.set(c,r),l.push({symbol:r.toJSON(),id:c,glyphIds:i}),c++)}else{s.set(c,r);var a=[];e.forEach(function(e){return a.push(e)}),l.push({symbol:r.toJSON(),id:c,glyphIds:a}),c++}}),l.length>0?this.remoteClient.invoke("tileRenderer.getMaterialItems",l).then(function(e){for(var r=0,t=e;r<t.length;r++){var n=t[r],l=s.get(n.id);if(l)if(m.isTextSymbol(l))if(o.has(l.id)){var u=o.get(l.id),c=u.glyphMosaicItems,p=n.mosaicItem.glyphMosaicItems;if(p)for(var f=0;f<p.length;f++)null!=p[f]&&(c[f]=p[f])}else o.set(l.id,n.mosaicItem);else o.set(l.id,n.mosaicItem)}return a.release(s),i}):(a.release(n),u.resolve(i))},r.prototype._getLabelClassInfos=function(e){return this.labelClassInfos.map(function(e,r){return{id:r,labelClassInfo:e}}).filter(function(r){var t=r.labelClassInfo;return(!t.labelClass.minScale||t.labelClass.minScale>=e||0===t.labelClass.minScale)&&(!t.labelClass.maxScale||t.labelClass.maxScale<=e||0===t.labelClass.maxScale)})},r.prototype._createLabelFeatures=function(e,r,t,n){if(!this.labelingInfo||!r||0===r.length)return null;var s=new o({viewingMode:"",scale:e}),l=this._getLabelClassInfos(e);if(0===l.length)return null;for(var u=a.acquire(),c=new b.default(g.COLLISION_EARLY_REJECT_BUCKET_SIZE),f=0,d=r;f<d.length;f++){var y=d[f],h=this.service.geometryType,m=0,v=0;if("esriGeometryPoint"===h||"esriGeometryPolygon"===h){if("esriGeometryPoint"===h){var I=y.geometry;m=I.x,v=I.y}else m=y.centroid.x,v=y.centroid.y;if(c.checkOverlap(m,v))continue}for(var _=y.attributes[this.service.objectIdField],C=new Array,P=0;P<l.length;P++){var O=l[P],w=O.labelClassInfo,x=O.id,T=y;if(this.configuration.hasGeometryExpr){if(!n)return void M.error("mapview-labeling","Tried to evaluate geometry expression but no transformation found");var L=n.transform,R=n.hasZ,G=n.hasM,F=this.hydrate(y.geometry,L,R,G),j=i({},y,{geometry:F});F.spatialReference=p.fromJSON(this.spatialReference),T=j}var U=S.bidiText(this._evaluateLabelExpression(T,w,s)),k=U[0],B=U[1];if(g.DEBUG_LABELS){var D="-"+_;k=k.substring(0,k.length-D.length)+D}k&&k.length&&(E(w.labelClass.symbol,k,t),C.push({text:k,rtl:B,id:x}))}u.set(_,C)}return u},r.prototype._evaluateLabelExpression=function(e,r,t){if(!r.labelClass.symbol)return"";if(!f.evaluateWhere(r.labelClass.where,e.attributes))return"";if(!r.labelExpression.expression)return"";var n=i({view:t},r.labelOptions);return d.buildLabelText(r.labelExpression.expression,e,this.fields,n)},n([c.property({readOnly:!0})],r.prototype,"supportsTileUpdates",null),n([c.property()],r.prototype,"configuration",void 0),n([c.property({dependsOn:["configuration"]})],r.prototype,"labelingInfo",null),n([c.property({dependsOn:["labelingInfo"]})],r.prototype,"labelClassInfos",null),n([c.property({dependsOn:["service"]})],r.prototype,"hydrate",null),n([c.property({dependsOn:["configuration","service","fields","tileStore"]})],r.prototype,"factory",null),n([c.property({constructOnly:!0})],r.prototype,"queryInfo",null),n([c.property({dependsOn:["configuration"]})],r.prototype,"renderer",null),n([c.property({dependsOn:["configuration"]})],r.prototype,"rendererInfo",null),n([c.property({readOnly:!0})],r.prototype,"updating",null),n([c.property({dependsOn:["service"]})],r.prototype,"fields",null),r=n([c.subclass()],r)}(c.declared(C.default));r.default=T});